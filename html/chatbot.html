<!DOCTYPE html>
<html>
<head>
  <title>ChatBot</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="container">
  <div id="chatBox" class="mt-3 p-3 border">
    <!-- Chat messages will be appended here -->
  </div>
  <div class="mt-3">
    <input id="messageInput" class="form-control" placeholder="Type your message here...">
  </div>
</div>

<!-- Modal -->
<div class="modal" tabindex="-1" role="dialog" id="userIdModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Enter User ID</h5>
      </div>
      <div class="modal-body">
        <input id="userIdInput" class="form-control" placeholder="User ID">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="saveUserId">Save</button>
      </div>
    </div>
  </div>
</div>

<script>
  function createChart(table, rowLabels, columnLabels, chartType, title, colorPalette) {
    // Create a canvas to draw the chart on
    var canvas = document.createElement('canvas');
    $('#chatBox').append(canvas);
    let indexAxis = 'x';
    if (chartType=='bar') {
      indexAxis = 'y';
    } else if (chartType=='column') {
      chartType = 'bar';
    }

    let rowColors = table.length>1;
    console.log()
    // Prepare the dataset
    var datasets = table.map((row, rowIndex) => {
      return {
        label: rowLabels[rowIndex],
        data: row,
        fill: false,
        backgroundColor: rowColors ? colorPalette[rowIndex%colorPalette.length] : getColors(colorPalette, row.length),
        borderColor: 'rgba(0,0,0,1)',
        borderWidth: 1,
        tension: 0.1 // This is for line chart
      };
    });

    // Create the chart
    var ctx = canvas.getContext('2d');
    var chart = new Chart(ctx, {
      type: chartType,
      data: {
        labels: columnLabels,
        datasets: datasets
      },
      options: {
        indexAxis: indexAxis,
        responsive: true,
        plugins: {
          legend: {
            display: rowColors,
            position: 'top'
          },
          title: {
            display: true,
            text: title
          }
        }
      }
    });
  }

  function getColors(colors, length) {
    if (length <= colors.length) {
      // If length is smaller or equal to the length of colors,
      // return a slice of the array
      return colors.slice(0, length);
    } else {
      // If length is larger than the length of colors,
      // copy elements from the colors array to fill the rest
      let result = [...colors];
      while (result.length < length) {
        result = result.concat(colors.slice(0, length - result.length));
      }
      return result;
    }
  }



  let colorPalette = [ // Tableau 20
    'rgba(31, 119, 180, 1)',
    'rgba(174, 199, 232, 1)',
    'rgba(255, 127, 14, 1)',
    'rgba(255, 187, 120, 1)',
    'rgba(44, 160, 44, 1)',
    'rgba(152, 223, 138, 1)',
    'rgba(214, 39, 40, 1)',
    'rgba(255, 152, 150, 1)',
    'rgba(148, 103, 189, 1)',
    'rgba(197, 176, 213, 1)',
    'rgba(140, 86, 75, 1)',
    'rgba(196, 156, 148, 1)',
    'rgba(227, 119, 194, 1)',
    'rgba(247, 182, 210, 1)',
    'rgba(127, 127, 127, 1)',
    'rgba(199, 199, 199, 1)',
    'rgba(188, 189, 34, 1)',
    'rgba(219, 219, 141, 1)',
    'rgba(23, 190, 207, 1)',
    'rgba(158, 218, 229, 1)'
  ];

  function chartData(chart) {
    let transpose = chart.table.length > chart.table[0].length;
    console.log(transpose);
    let table, rowLabels,columnLabels;
    if (transpose) {
      table = chart.table[0].map((_, colIndex) => chart.table.map(row => row[colIndex]));
      rowLabels = chart.columnLabels;
      columnLabels = chart.rowLabels;
    } else {
      table = chart.table;
      rowLabels = chart.rowLabels;
      columnLabels = chart.columnLabels;
    }
    createChart(table, rowLabels, columnLabels, chart.chartType, chart.title, colorPalette);
  }

  let userId = '';

  $(document).ready(function() {
    $('#userIdModal').modal({backdrop: 'static', keyboard: false});

    $('#saveUserId').click(function() {
      userId = $('#userIdInput').val();
      $('#userIdModal').modal('hide');
    });

    $('#messageInput').keypress(function(e) {
      if(e.which == 13) {
        let message = $('#messageInput').val();
        $('#messageInput').val('');
        $('#chatBox').append(`<p>You:</p><p>${message}</p>`);

        $.ajax({
          url: 'http://localhost:8080/messages',
          type: 'post',
          dataType: 'json',
          contentType: 'application/json',
          data: JSON.stringify({
            userId: userId,
            content: message
          }),
          success: function(data) {
            $('#chatBox').append(`<p>Assistant:</p>`);
            if (data.content) {
              let contentHtml = marked.parse(data.content);
              $('#chatBox').append(`<div>${contentHtml}</div>`);
            } else if (data.chart) {
              let chart = data.chart;
              console.log(chart);
              chartData(chart);
            } else {
              console.error("Invalid response: " + data);
            }
          }
        });
      }
    });
  });
</script>
</body>
</html>